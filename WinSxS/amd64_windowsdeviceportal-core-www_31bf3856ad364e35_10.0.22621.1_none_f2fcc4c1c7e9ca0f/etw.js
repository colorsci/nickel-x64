function EtwProvidersManager(){function i(n,t){return n.Name<t.Name?-1:n.Name>t.Name?1:0}function u(n,t,i){var f=$("#"+n),e=$("#"+i),u,r;f.children().remove();for(u in t)r=t[u],f.append($("<option>",{value:r.GUID,text:r.Name})),u==0&&e.val(r.Level?r.Level:EtwProvidersManager.TraceLevelVerbose)}function t(t,i,r){var u,f;if(i===!0){for(f=!1,n.etwSession.enableProvider(t,{level:r}),u=0;u<n.enabledProviders.length;u++)if(n.enabledProviders[u].GUID===t){f=!0;break}f===!1&&n.enabledProviders.push({GUID:t,EnabledLevel:r});o(t,r)}else for(n.etwSession.disableProvider(t),u=0;u<n.enabledProviders.length;u++)if(n.enabledProviders[u].GUID===t){n.enabledProviders.splice(u,1);break}e(n.enabledProviders)}function f(t){for(var i in n.registeredProviders)if(t===n.registeredProviders[i].GUID)return n.registeredProviders[i].Name;return t}function o(t,i){var o=!1,e=!1,u,s;for(u in n.historicProviders)if(n.historicProviders[u].GUID===t){n.historicProviders[u].Level!==i&&(n.historicProviders[u].Level=i,localStorage.providersHistory=JSON.stringify(n.historicProviders),e=!0);o=!0;break}o||(s=f(t),n.historicProviders.push({GUID:t,Name:s,Level:i}),localStorage.providersHistory=JSON.stringify(n.historicProviders),e=!0);e&&r()}function r(){$("#enableHistoricProvider").prop("disabled",n.historicProviders.length==0);u("historicProviders",n.historicProviders,"traceLevelsHistoricProvider")}function e(n){var r,t;if($("#enabledProviders").children().remove(),$("#disableProvider").prop("disabled",!0),$("#stopTracing").prop("disabled",!0),n){n=n.sort(i);for(r in n)t=n[r],t.Name=f(t.GUID),$("#enabledProviders").append($("<option>",{value:t.GUID,text:t.Name+" (Level: "+t.EnabledLevel+")"}));n.length>0&&($("#disableProvider").prop("disabled",!1),$("#stopTracing").prop("disabled",!1))}}function s(){var t=new WebbRest;t.getRegisteredEtwProviders().done(function(t){n.registeredProviders=t.Providers;h();c()})}function h(){n.registeredProviders=n.registeredProviders.sort(i);u("registeredProviders",n.registeredProviders);e();n.historicProviders=[];localStorage.providersHistory&&(n.historicProviders=JSON.parse(localStorage.providersHistory),n.historicProviders.sort(i));r(n.historicProviders)}function c(){$("#hideProvidersSection").prop("checked",!1).click(function(){$(this).prop("checked")?$("#providersSection").hide():$("#providersSection").show()});$("#enableRegisteredProvider").click(function(){t($("#registeredProviders option:selected").val(),!0,$("#traceLevelsRegisteredProvider option:selected").val())});$("#enableCustomProvider").click(function(){t($("#customProvider").val(),!0,$("#traceLevelsCustomProvider option:selected").val())});$("#disableProvider").click(function(){t($("#enabledProviders option:selected").val(),!1)});$("#stopTracing").click(function(){$("#enabledProviders option").each(function(){t($(this).val(),!1)})});$("#historicProviders").change(function(){var r=$("#historicProviders option:selected").val(),i,t;for(i in n.historicProviders)if(t=n.historicProviders[i],t.GUID===r){$("#traceLevelsHistoricProvider").val(t.Level?t.Level:EtwProvidersManager.TraceLevelVerbose);break}});$("#enableHistoricProvider").click(function(){t($("#historicProviders option:selected").val(),!0,$("#traceLevelsHistoricProvider option:selected").val())});$("#clearProviderHistory").click(function(){n.historicProviders=[];localStorage.providersHistory=JSON.stringify(n.historicProviders);r()})}function l(t){n.eventsViewer.onEventsAvailable(t)}function a(){$("#etwConnectionStatus").text("Connection to device lost! Please refresh the page to re-connect.").removeClass("hidden")}function v(){$("#etwConnectionStatus").text("Connection to device lost! Please refresh the page to re-connect.").removeClass("hidden")}var n=this;n.enabledProviders=[];EtwProvidersManager.TraceLevelVerbose=5;n.eventsViewer=new EtwEventsViewer("#etwEventsGrid",{gridLabel:"ETW events",rowHeaderName:"Provider"});$("#etwEventsGrid").innerHeight($("#content").innerHeight());n.etwSession=new EtwSession({onerror:a,onclose:v,onmessage:l});s();enableSlickGridTabbing("etwEventsGrid",!0)}function EtwEventsViewer(n,t){function l(){var u=[{id:"Timestamp",name:"Timestamp (Local Time)",field:"Timestamp",sortable:!1,width:236,cssClass:"tableCell",headerCssClass:"tableHeader"},{id:"Provider",name:"Provider",field:"ProviderName",sortable:!1,width:236,cssClass:"tableCell",headerCssClass:"tableHeader"},{id:"PID:TID",name:"PID:TID",field:"ProcessId",sortable:!1,width:128,cssClass:"tableCell",headerCssClass:"tableHeader"},{id:"ID",name:"ID",field:"ID",sortable:!1,width:32,cssClass:"tableCell",headerCssClass:"tableHeader"},{id:"TaskName",name:"Task",field:"TaskName",sortable:!1,width:128,cssClass:"tableCell",headerCssClass:"tableHeader"},{id:"OpCode",name:"OpCode",field:"OpCode",sortable:!1,width:32,cssClass:"tableCell",headerCssClass:"tableHeader"},{id:"Keyword",name:"Keyword",field:"Keyword",sortable:!1,width:64,cssClass:"tableCell",headerCssClass:"tableHeader"},{id:"Level",name:"Level",field:"Level",sortable:!1,width:64,cssClass:"tableCell",headerCssClass:"tableHeader"},{id:"Payload",name:"Payload",field:"WebbCompletePayload",sortable:!1,width:screen.width*16,cssClass:"tableCell",headerCssClass:"tableHeader"}],f={selectedCellCssClass:"rowSelected",enableCellNavigation:!0,enableColumnReorder:!1,showHeaderRow:!0,syncColumnCellResize:!0,rowHeight:36.5,headerRowHeight:40.45,gridLabel:t.gridLabel,rowHeaderName:t.rowHeaderName,rowHeaderId:t.rowHeaderId,rowHeaderColumn:t.rowHeaderColumn};i=new Slick.Data.DataView;i.setItems([]);r=new Slick.Grid(n,i,u,f);r.registerPlugin(new Slick.AutoTooltips);$(window).resize(function(){$(n).innerHeight($("#content").innerHeight());r.resizeCanvas()});i.onRowCountChanged.subscribe(function(){r.updateRowCount();r.render()});i.onRowsChanged.subscribe(function(n,t){r.invalidateRows(t.rows);r.render()});s=new FilterManager;s.onFilterChanged(function(n){i.setFilterArgs(n);i.refresh()});i.setFilter(s.eventsFilterFunction)}function a(){$("#clearEvents").bind("click",function(){i.setItems([]);f=0;o=0;h(0,0)});$("#saveTrace").bind("click",v)}function h(n,t){n>t?($("#eventsCounter").text(n+" events (truncated to last "+t+")."),$("#eventsCounter").addClass("warning")):($("#eventsCounter").text(f+" events."),$("#eventsCounter").removeClass("warning"))}function v(){var t=i.getItems(),u,f,n,e,s,r;if(typeof Blob=="undefined"){alert("Operation failed - browser does not support blob format");return}for(u="Timestamp,Provider,ProcessId,ID,TaskName,OpCode,Keyword,Level",n=0;n<o;++n)u+=",Field"+n;u+="\r\n";f=[u];for(n in t){var h=t[n].Timestamp.replace(" ","-"),c=t[n].WebbCompletePayload.length>0?t[n].WebbCompletePayload.slice(0,-1):"",l=h+","+t[n].ProviderName+","+t[n].ProcessId+","+t[n].ID+","+t[n].TaskName+","+t[n].OpCode+","+t[n].Keyword+","+t[n].Level+","+c+"\r\n";f.push(l)}e=new Blob(f,{type:"text/plain",endings:"native"});s="EtwTrace.csv";window.navigator.msSaveOrOpenBlob?window.navigator.msSaveOrOpenBlob(e,s):(r=document.createElement("a"),r.download=s,r.href=window.URL.createObjectURL(e),r.onclick=y,r.style.display="none",document.body.appendChild(r),r.click())}function y(n){document.body.removeChild(n.target)}function u(n,t){for(var u=t-n.length,i="",r=0;r<u;r++)i+="0";return i+n}function p(n){var i=n/1e4-116444736e5,t=new Date(i),r=n%1e7,f=u((t.getMonth()+1).toString(),2)+"/"+u(t.getDate().toString(),2)+"/"+t.getFullYear(),e=u(t.getHours(),2)+":"+u(t.getMinutes().toString(),2)+":"+u(t.getSeconds().toString(),2)+"."+u(r.toString(),7);return f+" "+e}var e=this;e.maxEventCount=5e4;var i,r,f=0,o=0,s,c=["Timestamp","ProviderName","ID","TaskName","OpCode","Keyword","Level","WebbEventCounter","WebbCompletePayload","ProcessId","ThreadId"];this.onEventsAvailable=function(n){var t,u,s,r;for(t in n.Events){n.Events[t].WebbEventCounter=f;f++;n.Events[t].Timestamp=p(n.Events[t].Timestamp);n.Events[t].ProcessId+=":"+n.Events[t].ThreadId;n.Events[t].WebbCompletePayload="";u=0;for(s in n.Events[t])c.indexOf(s)===-1&&(n.Events[t].WebbCompletePayload+=s+":"+n.Events[t][s].toString()+", ",++u);u>o&&(o=u)}r=i.getItems();r=r.concat(n.Events);r.length>e.maxEventCount&&r.splice(0,r.length-e.maxEventCount);h(f,e.maxEventCount);i.setItems(r,"WebbEventCounter")};l();a()}function FilterManager(){function r(){var r=$("#filterType option:selected").val(),u=$("#filterText").val().toLowerCase(),i;if($("#filterText").val()!==""&&n[r]){if(n[r].isNumericFilter){if(i=parseInt(u),isNaN(i))return}else i=u;n[r].values.indexOf(i)===-1&&(n[r].values.push(i),f("activeFiltersSection",r,$("#filterType option:selected").text(),i),t&&t(n))}}function u(i,r){if(n[i]){var u=n[i].values.indexOf(r);u!=-1&&(n[i].values.splice(u,1),t&&t(n))}}function f(n,t,i,r){$(document.createElement("button")).bind("click",function(){u(t,r);$(this).remove()}).addClass("warning").text(i+" = "+r).appendTo($(document.getElementById(n)))}var n={byId:{values:[],fieldName:"ID",name:"ID",isNumericFilter:!0,exactMatch:!0},byKeyword:{values:[],fieldName:"Keyword",name:"Keyword",isNumericFilter:!0,exactMatch:!0},byLevel:{values:[],fieldName:"Level",name:"Level",isNumericFilter:!0,exactMatch:!0},byTaskName:{values:[],fieldName:"TaskName",name:"Task Name",isNumericFilter:!1,exactMatch:!1},byProvider:{values:[],fieldName:"ProviderName",name:"Provider Name",isNumericFilter:!1,exactMatch:!1},byRegEx:{values:[],fieldName:"WebbCompletePayload",name:"Text",isNumericFilter:!1,exactMatch:!1,regExp:!0}},t,i;$("#addFilter").bind("click",r);for(i in n)$("#filterType").append($("<option>",{value:i,text:n[i].name}));this.eventsFilterFunction=function(n,t){var i,r,u;if(!t)return!0;for(i in t)if(t[i].values.length>0){r=!1;for(u in t[i].values)if(t[i].exactMatch){if(n[t[i].fieldName]===t[i].values[u]){r=!0;break}}else if(t[i].regExp){if(n[t[i].fieldName].toLowerCase().search(t[i].values[u])!==-1){r=!0;break}}else if(n[t[i].fieldName].toLowerCase().indexOf(t[i].values[u])!==-1){r=!0;break}if(!r)return!1}return!0};this.filterArguments=n;this.onFilterChanged=function(n){t=n}}(function(n){function t(t){function e(e){t=n.extend(!0,{},f,t);i=e;t.enableForCells&&i.onMouseEnter.subscribe(r);t.enableForHeaderCells&&i.onHeaderMouseEnter.subscribe(u)}function o(){t.enableForCells&&i.onMouseEnter.unsubscribe(r);t.enableForHeaderCells&&i.onHeaderMouseEnter.unsubscribe(u)}function r(r){var f=i.getCellFromEvent(r),e,u;f&&(e=n(i.getCellNode(f.row,f.cell)),u=n.trim(e.text()),t.maxToolTipLength&&u.length>t.maxToolTipLength&&(u=u.substr(0,t.maxToolTipLength-3)+"..."),e.attr("title",u))}function u(t,i){var u=i.column,r=n(t.target).closest(".slick-header-column");u.toolTip||r.attr("title",r.innerWidth()<r[0].scrollWidth?u.name:"")}var i,s=this,f={enableForCells:!0,enableForHeaderCells:!1,maxToolTipLength:null};n.extend(this,{init:e,destroy:o})}n.extend(!0,window,{Slick:{AutoTooltips:t}})})(jQuery);var WebbRest,EtwSession;$(function(){new EtwProvidersManager});
/*!
//@ sourceURL=tools/Etw/Etw.js
*/
