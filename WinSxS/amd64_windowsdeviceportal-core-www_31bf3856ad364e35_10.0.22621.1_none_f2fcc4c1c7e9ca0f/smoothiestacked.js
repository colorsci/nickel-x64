(function(n){function i(n,t){this.options=r.extend({},i.defaultOptions,n);this.data=[];this.maxValue=Number.NaN;this.minValue=Number.NaN;this.dropOldDataCallback=t}function t(n,i){this.options=r.extend({},t.defaultChartOptions,n);this.seriesSet=[];this.currentValueRange=1;this.currentVisMinValue=0;this.lastRenderTimeMillis=0;this.lastRenderTimeMillisBeforeScrolling=0;this.maxRenderTimeMillis=0;this.lastDivision;this.mousemove=this.mousemove.bind(this);this.mouseout=this.mouseout.bind(this);this.mousewheel=this.mousewheel.bind(this);this.mousedown=this.mousedown.bind(this);this.mouseup=this.mouseup.bind(this);this.mouseoverDataCallback=i;this.stopped=!0;this.lastMouseOverCallbackTime=0}var r={extend:function(){var n,t;for(arguments[0]=arguments[0]||{},n=1;n<arguments.length;n++)for(t in arguments[n])arguments[n].hasOwnProperty(t)&&(arguments[0][t]=typeof arguments[n][t]=="object"?arguments[n][t]instanceof Array?arguments[n][t]:r.extend(arguments[0][t],arguments[n][t]):arguments[n][t]);return arguments[0]},binarySearch:function(n,t){for(var i=0,u=n.length,r;i<u;)r=i+u>>1,t<n[r][0]?u=r:i=r+1;return i-1}};i.defaultOptions={resetBoundsInterval:3e3,resetBounds:!0,show:!0};i.prototype.resetBounds=function(){var i,r,t,n;if(this.data.length)for(i=this.data[0][1],r=this.data[0][2],this.maxValue=Math.max(i,r),this.minValue=Math.min(i,r),t=1;t<this.data.length;t++)n=this.data[t][1],n>this.maxValue&&(this.maxValue=n),n<this.minValue&&(this.minValue=n),n=this.data[t][2],this.value>this.maxValue&&(this.maxValue=this.value),this.value<this.minValue&&(this.minValue=this.value);else this.maxValue=Number.NaN,this.minValue=Number.NaN};i.prototype.append=function(n,t,i,r){for(var u=this.data.length-1,f,e;u>0&&this.data[u][0]>n;)u--;this.data.length>0&&this.data[u][0]===n?r?(this.data[u][1]+=t,this.data[u][2]+=i,t=this.data[u][1],i=this.data[u][2]):(this.data[u][1]=t,this.data[u][2]=i):u<this.data.length-1?this.data.splice(u+1,0,[n,t,i]):this.data.push([n,t,i]);f=Math.min(t,i);e=Math.max(t,i);this.maxValue=isNaN(this.maxValue)?e:Math.max(this.maxValue,e);this.minValue=isNaN(this.minValue)?f:Math.min(this.minValue,f)};i.prototype.dropOldData=function(n,t){for(var i=0,r;this.data.length-i>=t&&this.data[i+1][0]<n;)i++;i!==0&&(r=this.data.splice(0,i),this.dropOldDataCallback&&this.dropOldDataCallback(r))};t.defaultChartOptions={millisPerPixel:20,enableDpiScaling:!0,yMinFormatter:function(n,t){return parseFloat(n).toFixed(t)},yMaxFormatter:function(n,t){return parseFloat(n).toFixed(t)},maxValueScale:1,interpolation:"step",scaleSmoothing:.125,maxDataSetLength:2,grid:{fillStyle:"#000000",strokeStyle:["#777777","#ffffff"],lineWidth:1,sharpLines:!1,millisPerLine:1e3,minHorizontalDistance:10,divisionValues:[1,5,10,100],borderVisible:!0},labels:{fillStyle:"#ffffff",disabled:!1,fontSize:10,fontFamily:"monospace",precision:2},horizontalLines:[]};t.AnimateCompatibility=function(){var n=function(n,t){var i=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(n){return window.setTimeout(function(){n((new Date).getTime())},16)};return i.call(window,n,t)},t=function(n){var t=window.cancelAnimationFrame||function(n){clearTimeout(n)};return t.call(window,n)};return{requestAnimationFrame:n,cancelAnimationFrame:t}}();t.defaultSeriesPresentationOptions={lineWidth:1,strokeStyle:"#ffffff"};t.prototype.addTimeSeriesStacked=function(n,i){this.seriesSet.push({timeSeriesStacked:n,options:r.extend({},t.defaultSeriesPresentationOptions,i)});n.options.resetBounds&&n.options.resetBoundsInterval>0&&(n.resetBoundsTimerId=setInterval(function(){n.resetBounds()},n.options.resetBoundsInterval))};t.prototype.removeTimeSeriesStacked=function(n){for(var i=this.seriesSet.length,t=0;t<i;t++)if(this.seriesSet[t].timeSeriesStacked===n){this.seriesSet.splice(t,1);break}n.resetBoundsTimerId&&clearInterval(n.resetBoundsTimerId)};t.prototype.getTimeSeriesStackedOptions=function(n){for(var i=this.seriesSet.length,t=0;t<i;t++)if(this.seriesSet[t].timeSeriesStacked===n)return this.seriesSet[t].options};t.prototype.bringToFront=function(n){for(var i,r=this.seriesSet.length,t=0;t<r;t++)if(this.seriesSet[t].timeSeriesStacked===n){i=this.seriesSet.splice(t,1);this.seriesSet.push(i[0]);break}};t.prototype.streamTo=function(n,t){this.canvas=n;this.delay=t;this.start()};t.prototype.updateMouseoverData=function(n){var i,t;if(this.mouseover&&(i=(new Date).getTime(),!n||this.lastMouseOverCallbackTime+250<i)){t=this.lastRenderTimeMillis-(this.delay||0);t-=t%this.options.millisPerPixel;var o=this.options.scrollBackwards?t-this.mouseX*this.options.millisPerPixel:t-(this.canvas.offsetWidth-this.mouseX)*this.options.millisPerPixel,u=[],e=this.seriesSet[0].timeSeriesStacked,f=r.binarySearch(e.data,o);f>=0&&f<e.data.length&&u.push(f);u.length&&this.mouseoverDataCallback&&(this.lastMouseOverCallbackTime=i,this.mouseoverDataCallback(u))}};t.prototype.handleScrolling=function(){if(this.mouseIsDown&&this.stopped){var n=this.mouseX-this.mousedownX;this.lastRenderTimeMillis=Math.min(this.maxRenderTimeMillis,this.lastRenderTimeMillisBeforeScrolling-n*this.options.millisPerPixel);this.renderSingleFrameWhenStopped(!0)}};t.prototype.zoomAtMouseCursor=function(n){var t,i;if(this.mouseover){t=this.options.millisPerPixel+n;!isNaN(this.options.millisPerPixelMax)&&t>this.options.millisPerPixelMax?t=this.options.millisPerPixelMax:!isNaN(this.options.millisPerPixelMin)&&t<this.options.millisPerPixelMin&&(t=this.options.millisPerPixelMin);i=this.lastRenderTimeMillis-(this.delay||0);i-=i%this.options.millisPerPixel;var r=this.canvas.offsetWidth-this.mouseX,u=i-r*this.options.millisPerPixel,f=u+r*t;this.lastRenderTimeMillis=Math.min(this.maxRenderTimeMillis,f+(this.delay||0));this.options.millisPerPixel=t;this.renderSingleFrameWhenStopped(!0)}};t.prototype.mousewheel=function(n){this.stopped&&(n.preventDefault(),n.wheelDelta>0?this.zoomAtMouseCursor(-.2):n.wheelDelta<0&&this.zoomAtMouseCursor(.2))};t.prototype.mousedown=function(){this.mousedownX=this.mouseX;this.lastRenderTimeMillisBeforeScrolling=this.lastRenderTimeMillis;this.mouseIsDown=!0};t.prototype.mouseup=function(){this.mouseIsDown=!1};t.prototype.mousemove=function(n){this.mouseover=!0;this.mouseX=n.offsetX;this.mouseY=n.offsetY;this.mousePageX=n.pageX;this.mousePageY=n.pageY;this.updateMouseoverData(!1);this.handleScrolling()};t.prototype.mouseout=function(){this.mouseover=!1;this.mouseX=this.mouseY=-1};t.prototype.start=function(){var n,i,r;this.frame||(isNaN(this.options.millisPerPixelDefault)||(this.options.millisPerPixel=this.options.millisPerPixelDefault),this.stopped=!1,this.options.enableDpiScaling&&window&&window.devicePixelRatio!==1&&(n=this.canvas.getAttribute("width"),i=this.canvas.getAttribute("height"),this.canvas.setAttribute("width",n*window.devicePixelRatio),this.canvas.setAttribute("height",i*window.devicePixelRatio),this.canvas.style.width=n+"px",this.canvas.style.height=i+"px",this.canvas.getContext("2d").scale(window.devicePixelRatio,window.devicePixelRatio)),this.canvas.addEventListener("mousemove",this.mousemove),this.canvas.addEventListener("mouseout",this.mouseout),this.canvas.addEventListener("mousewheel",this.mousewheel),this.canvas.addEventListener("mousedown",this.mousedown),this.canvas.addEventListener("mouseup",this.mouseup),r=function(){this.frame=t.AnimateCompatibility.requestAnimationFrame(function(){this.render();r()}.bind(this))}.bind(this),r())};t.prototype.stop=function(){this.frame&&(t.AnimateCompatibility.cancelAnimationFrame(this.frame),delete this.frame);this.maxRenderTimeMillis=this.lastRenderTimeMillis;this.stopped=!0};t.prototype.updateValueRange=function(){for(var i,f,r=this.options,n=Number.NaN,t=Number.NaN,u=0;u<this.seriesSet.length;u++)(i=this.seriesSet[u].timeSeriesStacked,i.options.show)&&(isNaN(i.maxValue)||(n=isNaN(n)?i.maxValue:Math.max(n,i.maxValue)),isNaN(i.minValue)||(t=isNaN(t)?i.minValue:Math.min(t,i.minValue)));if(r.maxValue!=null?n=r.maxValue:n*=r.maxValueScale,r.minValue!=null&&(t=r.minValue),this.options.yRangeFunction&&(f=this.options.yRangeFunction({min:t,max:n}),t=f.min,n=f.max),!isNaN(n)&&!isNaN(t)){var s=n-t,e=s-this.currentValueRange,o=t-this.currentVisMinValue;this.isAnimatingScale=Math.abs(e)>.1||Math.abs(o)>.1;this.currentValueRange+=r.scaleSmoothing*e;this.currentVisMinValue+=r.scaleSmoothing*o}this.valueRange={min:t,max:n}};t.prototype.renderSingleFrameWhenStopped=function(n){this.stopped&&t.AnimateCompatibility.requestAnimationFrame(function(){this.render(undefined,undefined,n)}.bind(this))};t.prototype.render=function(n,t,i){var p=(new Date).getTime(),lt,it,v,c,rt,b,ut,ft,k,d,y,e,o,h,g,nt,ht,ct,tt;if(this.updateMouseoverData(!0),this.isAnimatingScale||(lt=Math.min(1e3/6,this.options.millisPerPixel),!(p-this.lastRenderTimeMillis<lt))){this.stopped?p=this.lastRenderTimeMillis:this.lastRenderTimeMillis=p;n=n||this.canvas;t=t||p-(this.delay||0);t-=t%this.options.millisPerPixel;var r=n.getContext("2d"),u=this.options,f={top:0,left:0,width:n.clientWidth,height:n.clientHeight},at=t-f.width*u.millisPerPixel,a=function(n){var t=n-this.currentVisMinValue;return this.currentValueRange===0?f.height:f.height-Math.round(t/this.currentValueRange*f.height)}.bind(this),vt=function(n){return f.height==0?0:Math.round((f.height-n)*this.currentValueRange/f.height)+this.currentVisMinValue}.bind(this),w=function(n){return Math.round(f.width-(t-n)/u.millisPerPixel)};if(this.updateValueRange(),r.font=u.labels.fontSize+"px "+u.labels.fontFamily,r.save(),r.translate(f.left,f.top),r.beginPath(),r.rect(0,0,f.width,f.height),r.clip(),r.save(),r.fillStyle=u.grid.fillStyle,r.clearRect(0,0,f.width,f.height),r.fillRect(0,0,f.width,f.height),r.restore(),r.save(),r.lineWidth=u.grid.lineWidth,r.strokeStyle=u.grid.strokeStyle[0],u.grid.millisPerLine>0)for(it=f.width-r.measureText(tt).width+4,v=t-t%u.grid.millisPerLine;v>=at;v-=u.grid.millisPerLine)if(c=w(v),u.grid.sharpLines&&(c-=.5),r.beginPath(),r.moveTo(c,0),r.lineTo(c,f.height),r.stroke(),r.closePath(),u.timestampFormatter&&c<it){var wt=new Date(v),yt=u.timestampFormatter(wt),pt=r.measureText(yt).width;it=c-pt-2;r.fillStyle=u.labels.fillStyle;r.fillText(yt,c-pt,f.height-2)}for(e=0;e<u.grid.divisionValues.length;){if(Math.round(u.grid.divisionValues[e]/this.currentValueRange*f.height)>u.grid.minHorizontalDistance)break;e++}for(rt=[u.grid.divisionValues[e],u.grid.divisionValues[e+1]!=undefined?u.grid.divisionValues[e+1]:u.grid.divisionValues[e]*2],this.options.divisionValueChangedFunction&&this.options.divisionValueChangedFunction(rt[0]),e=0;e<2;e++){for(b=rt[e],r.strokeStyle=u.grid.strokeStyle[e],ut=vt(f.height),ft=vt(0),ut-=b,ft+=b,k=ut;k<ft;k+=b)d=a(k),u.grid.sharpLines&&(d-=.5),r.beginPath(),r.moveTo(0,d),r.lineTo(f.width,d),r.stroke(),r.closePath();u.grid.borderVisible&&(r.beginPath(),r.strokeRect(0,0,f.width,f.height),r.closePath());r.restore()}for(y=0;y<this.seriesSet.length;y++){var et=this.seriesSet[y].timeSeriesStacked,s=et.data,l=this.seriesSet[y].options;if((i||et.dropOldData(at,u.maxDataSetLength),et.options.show)&&s.length>1&&l.fillStyle){for(r.save(),r.lineWidth=1,r.strokeStyle=l.fillStyle,r.beginPath(),e=0;e<s.length-1;e++){var bt=w(s[e+0][0]),kt=w(s[e+1][0]),dt=a(s[e][1]),gt=a(s[e][2]);for(o=bt;o<kt;o++)r.moveTo(o+.5,dt),r.lineTo(o+.5,gt)}r.stroke();r.closePath();r.restore();r.save();r.lineWidth=l.lineWidth;r.strokeStyle=l.strokeStyle;r.beginPath();var ni=0,ot=0,st=0;for(e=0;e<s.length&&s.length!==1;e++){if(o=w(s[e][0]),h=a(s[e][1])-.5,e===0)ni=o,r.moveTo(o,h);else switch(u.interpolation){case"linear":case"line":r.lineTo(o,h);break;case"bezier":default:r.bezierCurveTo(Math.round((ot+o)/2),st,Math.round(ot+o)/2,h,o,h);break;case"step":r.lineTo(o,st);r.lineTo(o,h);break;case"point":r.moveTo(o,h)}ot=o;st=h}l.strokeStyle&&l.strokeStyle!=="none"&&r.stroke();r.closePath();r.restore()}}if(u.horizontalLines&&u.horizontalLines.length)for(g=0;g<u.horizontalLines.length;g++)nt=u.horizontalLines[g],ht=Math.round(a(nt.value))-.5,r.strokeStyle=nt.color||"#ffffff",r.lineWidth=nt.lineWidth||1,r.beginPath(),r.moveTo(0,ht),r.lineTo(f.width,ht),r.stroke(),r.closePath();this.mouseX>=0&&(r.lineWidth=1,r.strokeStyle="#BBBBBB",r.beginPath(),r.moveTo(this.mouseX,0),r.lineTo(this.mouseX,f.height),r.closePath(),r.stroke());u.labels.disabled||isNaN(this.valueRange.min)||isNaN(this.valueRange.max)||(ct=u.yMaxFormatter(this.valueRange.max,u.labels.precision),tt=u.yMinFormatter(this.valueRange.min,u.labels.precision),r.fillStyle=u.labels.fillStyle,r.fillText(ct,f.width-r.measureText(ct).width-2,u.labels.fontSize),r.fillText(tt,f.width-r.measureText(tt).width-2,f.height-2));r.restore()}};t.timeFormatter=function(n){function t(n){return(n<10?"0":"")+n}return t(n.getHours())+":"+t(n.getMinutes())+":"+t(n.getSeconds())};n.TimeSeriesStacked=i;n.SmoothieChartStacked=t})(typeof exports=="undefined"?this:exports)