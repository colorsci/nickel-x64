function FramerateChart(n,t){function vi(){k=new CBuffer(ct);ht=new CBuffer(ct-1);f=-1;o=new SmoothieChart({fillStyle:"#fff",minValue:0,maxValue:120,interpolation:"step",enableDpiScaling:!1,labels:{fillStyle:"rgb(58, 58, 58)",fontSize:15},grid:{fillStyle:"transparent",strokeStyle:"rgb(217, 234, 244)",verticalSections:8}});o.addTimeSeries(tt,{strokeStyle:"rgb(17, 125, 187)",fillStyle:"rgba(17, 125, 187, 0.05)",lineWidth:1});o.addTimeSeries(it,{strokeStyle:"rgb(90, 90, 90)",fillStyle:"rgba(168, 168, 168, 0.2)",lineWidth:1});o.streamTo(document.getElementById("framerateChart"),1e3);$("#framerate").attr({style:"color:rgb(17, 125, 187); margin:0px 2px 0px 0px;"});HighlightHoverAndFocus("#framerateValue",tt,o);$("#avgFramerate").attr({style:"color:rgb(168, 168, 168); margin:0px 2px 0px 0px;"});HighlightHoverAndFocus("#avgFramerateValue",it,o);v=new SmoothieChart({fillStyle:"#fff",minValue:0,interpolation:"step",enableDpiScaling:!1,labels:{fillStyle:"rgb(58, 58, 58)",fontSize:15},grid:{fillStyle:"transparent",strokeStyle:"rgb(217, 234, 244)",verticalSections:8}});v.addTimeSeries(rt,{strokeStyle:"rgb(167, 79, 1)",fillStyle:"rgba(167, 79, 1, 0.05)",lineWidth:1});v.streamTo(document.getElementById("compositorMissedVBlankChart"),1e3);$("#compositorMissedVBlanks").attr({style:"color:rgb(167, 79, 1); margin:0px 2px 0px 0px;"});HighlightHoverAndFocus("#compositorMissedVBlanksValue",rt,v)}function yi(){var n=new AnalogWebbRest;n.getFpsStatus().done(function(n){n.Enabled?$("#fpsBox").prop("checked",!0):$("#fpsBox").prop("checked",!1)}).fail(function(n){n=="Not supported on VMs"&&$("#debugArtOptions").hide()});n.getFpsGraphStatus().done(function(n){n.Enabled?$("#fpsGraphBox").prop("checked",!0):$("#fpsGraphBox").prop("checked",!1)}).fail(function(n){n=="Not supported on VMs"&&$("#debugArtOptions").hide()})}function pi(n){di(n.Events,n.Frequency);d&&nu(n.Events,n.Frequency)}function wi(){alert("Connection to device lost! Please refresh the page to re-connect.")}function bi(n){n.pageUnloading||alert("Connection to device lost! Please refresh the page to re-connect.")}function ki(){var n=new WebbRest;n.getDeviceFamily().done(function(n){n.DeviceType==="Windows.Desktop"?(d=!0,$("#debugArtOptions").hide(),r.enableProvider(self.DHD1Provider,{keywords:29360128}),r.enableTaskNameFilter(self.DHD1Provider,"MissedPresentation"),r.enableTaskNameFilter(self.DHD1Provider,"LsrThread_BeginLsrProcessing"),r.enableTaskNameFilter(self.DHD1Provider,"OnConnectEvent"),r.enableProvider(self.DxgiProvier),r.enableIdFilter(self.DxgiProvier,self.cTokenVsyncDPC),r.enableProvider(self.SpectrumContinuousProvider,{keywords:4718592,level:self.WINEVENT_LEVEL_VERBOSE}),r.enableTaskNameFilter(self.SpectrumContinuousProvider,"HolographicFrame"),r.enableTaskNameFilter(self.SpectrumContinuousProvider,"FrameStatisticsScanout"),r.enableProvider(self.HydrogenCompositorProvider,{keywords:4194304,level:self.WINEVENT_LEVEL_VERBOSE}),r.enableTaskNameFilter(self.HydrogenCompositorProvider,"HolographicFrameScanout"),ru()):(d=!1,$("#compositorStatistics").hide(),$("#avgFramerate").hide(),$("#recordOptions").hide(),$("#presentstatsSection").hide(),r.enableProvider(self.ShellCompositorProvider,{keywords:72}))})}function di(n){var t;$.each(n,function(n,i){var o,r,h,u,s,a;if(d||i.TaskName!=="FramerateInfo")if(d&&p!=0){if(i.TaskName==="MissedPresentation")r=i.CurrentTimeQpc,t=new Date(y+1e3*((r-f)/p)),f==-1&&(y=(new Date).getTime(),f=r),rt.append(t,1),ii++,$("#compositorMissedVBlanksValue").html(ii);else if(i.TaskName==="LsrThread_BeginLsrProcessing"&&(r=i.CurrentTimeQpc,t=new Date(y+1e3*((r-f)/p)),f==-1&&(y=(new Date).getTime(),f=r),h=i.NewSourceLatched==="true"?1:0,ht.push(h),k.push(r),rt.append(t,0),k.size>=ct)){var c=ht.sum(),v=r-k.first(),l=v/p,e=c/l;e=parseFloat(Math.round(e*10)/10).toFixed(1);tt.append(t,e);$("#framerateValue").html(e);ut?(lt?(ri=k.first(),u=e,s=l,ft=c,lt=!1):(s=(r-ri)/p,ft+=h,u=ft/s,u=parseFloat(Math.round(u*10)/10).toFixed(1)),it.append(t,u),$("#avgFramerateValue").html(u),at&&(a=[ft,s,u,e],et.push(a))):it.append(t,0)}}else i.TaskName==="OnConnectEvent"&&(p=i.performanceFrequency);else f==-1&&(y=(new Date).getTime(),f=i.Timestamp),o=i.Framerate,o=parseFloat(Math.round(o*10)/10).toFixed(1),t=new Date(y+(i.Timestamp-f)/1e4),tt.append(t,o),$("#framerateValue").html(o)})}function gi(n){document.body.removeChild(n.target)}function nr(){for(var t,r,u,n,f=["FrameLatched (since recording), TimeInSeconds, FPS (averge since recording), FPS (average over last 15 frames)\r\n"],i=0;i<et.length;i++)t=et[i],f.push(t[0]+","+t[1]+","+t[2]+","+t[3]+"\r\n");r="FramerateRecordTrace.csv";u=new Blob(f,{type:"text/plain",endings:"native"});window.navigator.msSaveOrOpenBlob?window.navigator.msSaveOrOpenBlob(u,r):(n=document.createElement("a"),n.download=r,n.href=window.URL.createObjectURL(u),n.onclick=gi,n.style.display="none",document.body.appendChild(n),n.click())}function b(){b.CompletedMask=e.HolographicFrame_Stop^e.FrameStatisticsScanout^e.HolographicFrameScanout^e.LsrThread_BeginLsrProcessing;this.CompletedEvents=0;this.FrameId=0;this.ApplicationPoseRequestedTickQpc=0;this.PresentTickQpc=0;this.AppGpuFinishedTickQpc=0;this.LsrStartTickQpc=0;this.FrameScanoutVBlankTimeTickQpc=0;this.HasPlotted=!1;this.CreatedTimeChartMs=0;this.TotalLatencyMs=0}function a(n,t){return n*1e3/t}function rr(n){return n/1e4}function nt(n,t,i){var r=i.getTimeSeriesStackedOptions(t).fillStyle,u=i.getTimeSeriesStackedOptions(t).strokeStyle;$(n).hover(function(){var n=i.getTimeSeriesStackedOptions(t);n&&(n.fillStyle="rgba("+ot+","+h+")",n.strokeStyle="rgba("+ot+","+s+")")},function(){if($(n).is(":focus")===!1){var f=i.getTimeSeriesStackedOptions(t);f&&(f.fillStyle=r,f.strokeStyle=u)}});$(n).focus(function(){var n=i.getTimeSeriesStackedOptions(t);n&&(n.fillStyle="rgba("+ot+","+h+")",n.strokeStyle="rgba("+ot+","+s+")")}).blur(function(){if($(n).is(":hover")===!1){var f=i.getTimeSeriesStackedOptions(t);f.fillStyle=r;f.strokeStyle=u}})}function ur(n){var t=4*u;return isNaN(n.max)||(t=Math.max(t,Math.ceil(n.max/u)*u)),{min:0,max:t}}function fr(n){iu(function(){var i=yt.data[n[0]][1],t;$("#frameIdValue").html(" "+i);t=c[i];t&&$("#totalLatencyValue").html(" "+t.TotalLatencyMs.toFixed(3))})}function er(){var n={fillStyle:"#fff",interpolation:"step",enableDpiScaling:!1,labels:{fillStyle:"rgb(58, 58, 58)",fontSize:15},grid:{fillStyle:"transparent",strokeStyle:["rgb("+ci+")","rgb("+ci+")"],divisionValues:[u]},yRangeFunction:ur,millisPerPixel:20,millisPerPixelMax:20,millisPerPixelMin:2,millisPerPixelDefault:20};i=new SmoothieChartStacked(n,fr);i.streamTo(document.getElementById("latencyChartCanvas"),1e3);or();sr();hr();cr();lr();ar()}function or(){i.addTimeSeriesStacked(yt,{})}function sr(){i.addTimeSeriesStacked(pt,{strokeStyle:"rgba("+fi+","+s+")",fillStyle:"rgba("+fi+","+h+")",lineWidth:g});nt("#poseToPresentHover",pt,i)}function hr(){i.addTimeSeriesStacked(wt,{strokeStyle:"rgba("+ei+","+s+")",fillStyle:"rgba("+ei+","+h+")",lineWidth:g});nt("#presentToAppGpuFinishHover",wt,i)}function cr(){i.addTimeSeriesStacked(bt,{strokeStyle:"rgba("+oi+","+s+")",fillStyle:"rgba("+oi+","+h+")",lineWidth:g});nt("#appGpuFinishToLsrStartHover",bt,i)}function lr(){i.addTimeSeriesStacked(kt,{strokeStyle:"rgba("+si+","+s+")",fillStyle:"rgba("+si+","+h+")",lineWidth:g});nt("#lsrStartToVsyncHover",kt,i)}function ar(){i.addTimeSeriesStacked(dt,{strokeStyle:"rgba("+hi+","+s+")",fillStyle:"rgba("+hi+","+h+")",lineWidth:g});nt("#vsyncToPhotonHover",dt,i)}function st(n){var t=c[n];return t||(t=new b,t.FrameId=n,t.CreatedTimeChartMs=Date.now().valueOf(),c[n]=t),t}function vr(n){var t=st(n.holographicFrameID);t.ApplicationPoseRequestedTickQpc=parseInt(n.timePredictionWasMadeInTicks);t.PresentTickQpc=parseInt(n.currentTimeInTicks);t.CompleteEvent(e.HolographicFrame_Stop)}function yr(n){n.OpCode===tr&&n.isRehydration==="false"&&vr(n)}function pr(n){var t=st(n.LatchedFrameId);t.AppGpuFinishedTickQpc=parseInt(n.AppPresentationGPUWorkEndedQpc);t.CompleteEvent(e.FrameStatisticsScanout)}function wr(n){var t=st(n.holographicFrameID);t.FrameScanoutVBlankTimeTickQpc=parseInt(n.frameScanoutVBlankTimeTicks);t.CompleteEvent(e.HolographicFrameScanout)}function br(n){ti=parseFloat(n.vblankToPhotonsMidMs);var t=st(n.HolographicFrameId);t.EventCompleted(e.LsrThread_BeginLsrProcessing)||(t.LsrStartTickQpc=parseInt(n.CurrentTimeQpc),t.CompleteEvent(e.LsrThread_BeginLsrProcessing))}function kr(n){for(var t=0;t<n.length;t++)delete c[n[t][0]]}function dr(){var u,t,f,e,o,h;if(!w)for(u in c)if(t=c[u],Date.now().valueOf()-t.CreatedTimeChartMs>ir)delete c[u];else if(t.AllEventsCompleted()&&!t.HasPlotted){var n=0,i=0,s=a(t.ApplicationPoseRequestedTickQpc,l),r=vt+(s-ui);yt.append(r,t.FrameId);f=a(t.PresentTickQpc,l);i=f-s;pt.append(r,n+i,n);n+=i;e=a(t.AppGpuFinishedTickQpc,l);i=e-f;wt.append(r,n+i,n);n+=i;o=a(t.LsrStartTickQpc,l);i=o-e;bt.append(r,n+i,n);n+=i;h=a(t.FrameScanoutVBlankTimeTickQpc,l);i=h-o;kt.append(r,n+i,n);n+=i;dt.append(r,n+ti,n);n+=ti;t.TotalLatencyMs=n;t.HasPlotted=!0}}function gr(n,t){if(n.VidPnSourceId==1){if(gt==-1)gt=n.Timestamp;else if(ni==-1){ni=n.Timestamp;u=a(ni-gt,t);const r=1e3/90,f=1e3/60;r-.1<u&&u<r+.1?u=r:f-.1<u&&u<f+.1&&(u=f);i.options.grid.divisionValues=[u]}vt==-1?(vt=Date.now().valueOf(),ui=a(parseInt(n.FrameQPCTime),l),ai=rr(n.Timestamp)):dr()}}function nu(n,t){w||$.each(n,function(n,i){switch(i.TaskName){case"HolographicFrame":yr(i);break;case"FrameStatisticsScanout":pr(i);break;case"LsrThread_BeginLsrProcessing":br(i);break;case"OnConnectEvent":l=parseInt(i.performanceFrequency);break;case"HolographicFrameScanout":wr(i);break;case"VSyncDPC":gr(i,t)}})}function tu(){i&&i.stop();o&&o.stop();v&&v.stop()}function iu(n){n();w&&i.renderSingleFrameWhenStopped(!0)}function ru(){$("#pauseBtn").click(function(){w=!w;w?($("#pauseBtn").html("Resume"),i.stop()):($("#pauseBtn").html("Pause"),i.start())});$(window).one("beforeunload",tu)}var li='<div class="expandToAvailableSpace">                 <div id="debugArtOptions">                     <input type="checkbox" id="fpsBox">                     <label id="boxlabel" for="fpsBox">Display frame rate counter in headset<\/label>                     <br/>                    <input type="checkbox" id="fpsGraphBox">                     <label id="graphlabel" for="fpsGraphBox">Display frame rate graph in headset<\/label>                 <\/div>                 <div class="expandToAvailableSpace">                     <canvas id="framerateChart" height="'+t+'"><\/canvas>                 <\/div>                 <div class="chartLegend">                     <span><label id="framerate" for="framerateValue">App frames per second: <\/label><span id="framerateValue" tabindex="0"><\/span><\/span><br/>                     <span><label id="avgFramerate" for="avgFramerateValue"><\/label><span id="avgFramerateValue" tabindex="1"><\/span><\/span><br/><br/>                 <\/div >                 <div id="compositorStatistics">                     <div class="expandToAvailableSpace">                         <canvas id="compositorMissedVBlankChart" height="'+t+'"><\/canvas>                     <\/div>                     <div class="chartLegend">                         <span><label id="compositorMissedVBlanks" for="compositorMissedVBlanksValue" style="margin:0px 2px 0px 0px;">Compositor missed frames:<\/label><span id="compositorMissedVBlanksValue" tabindex="0">0<\/span><\/span>                     <\/div>                 <\/div>                 <div id="recordOptions">                     <p>Click Record to measure the average frame rate over a period of time.<\/p>                     <button type="button" id="recordBtn">Record<\/button>                     <input type="checkbox" id="saveCSVBox" checked="">                     <label for="saveCSVBox">Save as CSV<\/label>                 <\/div>                 <br/> <div id="presentstatsSection">                 <p class="sectionHeader" role="heading" aria-level="5"><label>Latency<\/label><\/p>                     <p/>                 <div class="expandToAvailableSpace">                     <canvas id="latencyChartCanvas" height="400"><\/canvas>                 <\/div>                 <div class="chartLegend">                     <span><label id="frameIdLabel">Frame ID: <\/label><span id="frameIdValue"><\/span><\/span><br/>                     <span><label id="totalLatencyLabel">Total latency (ms): <\/label><span id="totalLatencyValue"><\/span><\/span><br/>                 <\/div>                     <div>                         <button type="button" id="pauseBtn">Pause<\/button>                     <\/div>                     <div class="chartLegend">                         <p><div class="latencyLegend colorVsyncToPhoton"><\/div><span id="vsyncToPhotonHover">Flip-to-photon<\/span><\/p>                         <p><div class="latencyLegend colorLsrStartToVsync"><\/div><span id="lsrStartToVsyncHover">Late stage reprojection<\/span><\/p>                         <p><div class="latencyLegend colorAppGpuFinishToLsrStart"><\/div><span id="appGpuFinishToLsrStartHover">Compositor<\/span><\/p>                         <p><div class="latencyLegend colorPresentToAppGpuFinish"><\/div><span id="presentToAppGpuFinishHover">App post-present<\/span><\/p>                         <p><div class="latencyLegend colorPoseToPresent"><\/div><span id="poseToPresentHover">App pre-present<\/span><\/p>                     <\/div>                 <\/div>             <\/div>',r;$("#"+n).html(li);var o,v,tt=new TimeSeries,it=new TimeSeries,f,y,rt=new TimeSeries,ht,k,p=0,ii=0,d=!0,ct=16,ut=!1,lt=!1,ri,ft,at=!0,et=[],u=1e3/90,vt=-1,ui=-1,ai=-1;self.cTokenStateCompleted="2";self.cTokenStateChangedEventID=301;self.cTokenVsyncDPC=17;self.SpectrumContinuousProvider="356E1338-04AD-420E-8B8A-A2EB678541CF";self.ShellCompositorProvider="E369227C-EE2F-42D0-9734-CEC639966D99";self.DHD1Provider="19D9D739-DA0A-41A0-B97F-24ED27ABC9FB";self.DxgiProvier="802EC45A-1E99-4B83-9920-87C98277BA9D";self.HydrogenCompositorProvider="2161BF9E-E2A6-4463-B9AB-12FAA958D69B";self.WINEVENT_LEVEL_VERBOSE=5;r=new EtwSession({onerror:wi,onclose:bi,onmessage:pi,onopen:ki});vi();yi();$("#recordBtn").click(function(){$("#avgFramerate").html()===""&&$("#avgFramerate").html("App frames per second (recorded average): ");ut=!ut;ut?(lt=!0,$("#recordBtn").html("Stop"),$("#saveCSVBox").prop("disabled",!0),at=$("#saveCSVBox").prop("checked")):($("#recordBtn").html("Record"),$("#saveCSVBox").prop("disabled",!1),at&&(nr(),et=[]))});$("#fpsBox").click(function(){var n=new AnalogWebbRest;$("#fpsBox").prop("checked")?n.enableFps():n.disableFps()});$("#fpsGraphBox").click(function(){var n=new AnalogWebbRest;$("#fpsGraphBox").prop("checked")?n.enableFpsGraph():n.disableFpsGraph()});$(window).resize(function(){setWidthFromParent("framerateChart");setWidthFromParent("compositorMissedVBlankChart");setWidthFromParent("latencyChartCanvas")});$(document).ready(function(){setWidthFromParent("framerateChart");setWidthFromParent("compositorMissedVBlankChart");setWidthFromParent("latencyChartCanvas")});var g=1,s="1",h="0.25",fi="2, 71, 254",ei="255, 253, 110",oi="134, 1, 176",si="251, 153, 2",hi="150, 150, 150",ot="255, 0, 0",ci="217, 234, 244",tr=2,ir=2e5,yt=new TimeSeriesStacked({show:!1},kr),pt=new TimeSeriesStacked,wt=new TimeSeriesStacked,bt=new TimeSeriesStacked,kt=new TimeSeriesStacked,dt=new TimeSeriesStacked,c={},l=-1,gt=-1,ni=-1,ti=-1,i,w=!1,e=new function(){this.HolographicFrame_Stop=1;this.FrameStatisticsScanout=2;this.HolographicFrameScanout=4;this.LsrThread_BeginLsrProcessing=8};b.prototype.CompleteEvent=function(n){this.CompletedEvents|=n};b.prototype.EventCompleted=function(n){return(this.CompletedEvents&n)!=0};b.prototype.AllEventsCompleted=function(){return this.CompletedEvents===b.CompletedMask};er()}function setWidthFromParent(n){document.getElementById(n).width=$("#"+n).parent().width()}var SystemPerformanceConnection,FramerateChart,EtwSession,HighlightHoverAndFocus,WebbRest,CBuffer,TimeSeriesStacked,SmoothieChartStacked,AnalogWebbRest;$(function(){new FramerateChart("FrameRate",{height:150})})