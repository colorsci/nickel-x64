$(function(){function n(n,t){var r="",u=n,i;t!=undefined&&t.responseText!=undefined&&(i=jQuery.parseJSON(t.responseText),i!=undefined&&i.Reason!=undefined&&i.Reason.length!=0&&(r=i.Reason,i.CodeText!=undefined&&i.CodeText.length!=0&&(r=r+" "+i.CodeText)));r.length!=0&&(u=u+"\r\n"+r);alert(u)}function l(){var i=this,n,t;document.body.createTextRange?(n=document.body.createTextRange(),n.moveToElementText(i),n.select()):window.getSelection&&(t=window.getSelection(),n=document.createRange(),n.selectNodeContents(i),t.removeAllRanges(),t.addRange(n))}function a(n,t,i){var r=i/1024,u=r/1024,f=u/1024;return f>=1?f.toFixed(1)+" GB":u>=1?u.toFixed(1)+" MB":r>=1?r.toFixed(1)+" KB":i+" B"}function v(n,t,i){return new Date(i).toLocaleString()}function y(n,t,i){return'<span class="import symbol link" style="text-decoration: none;" aria-label="Restore" role="button" data-spaceID="'+i+'">Import<\/span>'}function p(n,t,i){return'<span class="delete symbol link" style="text-decoration: none;" aria-label="Delete" role="button" data-spaceID="'+i+'">Delete<\/span>'}function w(n,t,i){return'<span class="download symbol link" style="text-decoration: none;" aria-label="Download" role="button" data-spaceID="'+i+'">Download<\/span>'}function f(n,t){function u(n){r.setItems(n.files,"Id");r.beginUpdate();r.reSort();i.invalidate();r.endUpdate();$("#SpaceIdType").text(n.type)}var r=new Slick.Data.DataView,i=new Slick.Grid(n,r,[{id:"Id",name:"File Name",field:"Id",sortable:!0,width:375,cssClass:"tableCellClass guid-label",headerCssClass:"tableHeader"},{id:"Data",name:"Last Modified Date",field:"Date",sortable:!0,width:200,cssClass:"tableCellClass",headerCssClass:"tableHeader",formatter:v},{id:"Size",name:"Size",field:"Size",sortable:!0,width:100,cssClass:"tableCellClass",headerCssClass:"tableHeader",formatter:a},{id:"Import",name:"Import",field:"Id",sortable:!0,width:75,cssClass:"tableCellClass",headerCssClass:"tableHeader",formatter:y},{id:"Delete",name:"Delete",field:"Id",sortable:!0,width:75,cssClass:"tableCellClass",headerCssClass:"tableHeader",formatter:p},{id:"Download",name:"Download",field:"Id",sortable:!0,width:85,cssClass:"tableCellClass",headerCssClass:"tableHeader",formatter:w}],{selectedCellCssClass:"rowSelected",enableCellNavigation:!0,enableColumnReorder:!1,showHeaderRow:!0,syncColumnCellResize:!0,autoHeight:!0,enableTextSelectionOnCells:!0,rowHeight:36.5,headerRowHeight:40.45});this.ip="";this.mapGrid=i;this.UpdateLocalData=function(n){n&&(this.ip=n);t==="LocalHeTMap"?$.getJSONP(this.ip+"/api/holographic/mapmanager/mapFiles").done(u).fail(u):t==="LocalAnchors"?$.getJSONP(this.ip+"/api/holographic/mapmanager/anchorFiles").done(u).fail(u):t==="LocalSRDb"&&$.getJSONP(this.ip+"/api/holographic/mapmanager/srdbFiles").done(u).fail(u)};this.Clear=function(){this.ip="";u({maps:[]})};this.GetSelected=function(){var n=this.mapGrid.getActiveCell();return n?this.mapGrid.getDataItem(n.row):(alert("Please select a SpaceID guid from the list."),n)};$(window).resize(i.resizeCanvas.bind(i));r.onRowCountChanged.subscribe(function(){i.updateRowCount();i.render()});r.onRowsChanged.subscribe(function(n,t){i.invalidateRows(t.rows);i.render()});i.onSort.subscribe(function(n,t){var i=function(n,i){var r=n[t.sortCol.field],u=i[t.sortCol.field];return r===u?0:r>u?1:-1};r.sort(i,t.sortAsc)});i.setSortColumn("Date",!0)}function r(){$.get("/api/holographic/mapmanager/status").done(function(n){o=n.MapFileName;s=n.AnchorFileName;h=n.SrDbFileName;$("#LastLoadedMapFile").text(o);$("#LastLoadedAnchorFile").text(s);$("#LastLoadedSpatialMappingDbFile").text(h);t.UpdateLocalData();i.UpdateLocalData();u.UpdateLocalData();e.UpdateLocalData()})}function b(n,t,i,r,u){t>0?setTimeout(function(){n(function(f){f==r?u():b(n,t-1,i,r,u)})},i):u()}function k(n){function r(n){i.setItems(n.stores,"Id");i.beginUpdate();i.reSort();t.invalidate();i.endUpdate();this.userId=n.userid;$("#UserName").text(this.userId)}var i=new Slick.Data.DataView,t=new Slick.Grid(n,i,[{id:"Id",name:"Id",field:"Id",sortable:!0,width:350,cssClass:"tableCellClass guid-label",headerCssClass:"tableHeader"},{id:"SpatialNode",name:"SpatialNode",field:"SpatialNode",sortable:!0,width:350,cssClass:"tableCellClass guid-label",headerCssClass:"tableHeader"},{id:"App",name:"Owner App",field:"App",sortable:!0,width:350,cssClass:"tableCellClass",headerCssClass:"tableHeader"},{id:"Name",name:"Name",field:"Name",sortable:!0,width:350,cssClass:"tableCellClass",headerCssClass:"tableHeader"}],{selectedCellCssClass:"rowSelected",enableCellNavigation:!0,enableColumnReorder:!1,showHeaderRow:!0,syncColumnCellResize:!0,autoHeight:!0,enableTextSelectionOnCells:!0,rowHeight:36.5,headerRowHeight:40.45});this.ip="";this.anchorsGrid=t;this.UpdateLocalData=function(n){n&&(this.ip=n);$.getJSONP(this.ip+"/api/holographic/mapmanager/getanchors").done(r).fail(r)};this.Clear=function(){this.ip="";r({maps:[]})};this.GetSelected=function(){var n=this.anchorsGrid.getActiveCell();return n?this.anchorsGrid.getDataItem(n.row):(alert("Please select a SpaceID guid from the list."),n)};$(window).resize(t.resizeCanvas.bind(t));i.onRowCountChanged.subscribe(function(){t.updateRowCount();t.render()});i.onRowsChanged.subscribe(function(n,i){t.invalidateRows(i.rows);t.render()});t.onSort.subscribe(function(n,t){var r=function(n,i){var r=n[t.sortCol.field],u=i[t.sortCol.field];return r===u?0:r>u?1:-1};i.sort(r,t.sortAsc)});t.setSortColumn("Date",!0)}var o="",s="",h="",c=new WebbRest,e;c.getDeviceFamily().done(function(n){n.DeviceType==="Windows.Desktop"?($("#ResetSystemMapAndAnchorsAndSRDb").hide(),$("#ExportMapAndSpatialMappingDb").hide(),$("#LastLoadedSpatialMappingDbFileTitle").hide(),$("#LastLoadedSpatialMappingDbFile").hide(),$("#LocalSRDbFilesGridTitle").hide(),$("#LocalSRDbFilesGrid").hide(),$("#spatialMappingDbFileUpload").hide(),$("#UploadSpatialMappingDbFile").hide(),$("#spatialMappingFile").hide(),$("#UploadSpatialMappingDbFile").hide()):$("#ResetSystemMapAndAnchors").hide()});$.getJSONP=function(n,t,i){return $.get(n,t,i,"jsonp")};$.postJSON=function(n,t,i){return $.post(n,t,i,"json")};$.postJSONP=function(n,t,i){return $.post(n,t,i,"jsonp")};jQuery.fn.extend({bindAndBlock:function(n,t){var i=!1;return this.bind(n,function(){i||(i=!0,t.call(this,function(){i=!1}))})}});var t=new f("#LocalMapFilesGrid","LocalHeTMap"),i=new f("#LocalAnchorFilesGrid","LocalAnchors"),u=new f("#LocalSRDbFilesGrid","LocalSRDb");$("#LocalMapFilesGrid").on("click",".import",function(){var t=$(this),i=t.data("spaceid");window.confirm("Replace the current map with the selected map '"+i+"'?")&&(t.text("Importing ..."),$.post("/api/holographic/mapmanager/import?FileName="+i,function(){alert("Import was successful!")}).done(function(){r()}).fail(function(t){n("Failed to replace the map, check if the device is sleeping : "+t)}).always(function(){t.text("Import")}))});$("#LocalMapFilesGrid").on("click",".delete",function(){var i=$(this),r=i.data("spaceid");i.text("deleting ...");window.confirm("Delete selected map '"+r+"'?")&&$.post("/api/holographic/mapmanager/delete?FileName="+r).done(function(){t.UpdateLocalData()}).fail(function(t){n("Failed to delete :"+t)})});$("#LocalMapFilesGrid").on("click",".download",function(){var t=$(this),i=t.data("spaceid"),r="/api/holographic/mapmanager/download?FileName="+i,n=document.createElement("iframe");n.setAttribute("src",r);n.setAttribute("style","display: none");document.body.appendChild(n)});$("#LocalAnchorFilesGrid").on("click",".import",function(){var t=$(this),i=t.data("spaceid");window.confirm("Replace the system anchors with the selected anchors file '"+i+"'?")&&(t.text("Importing ..."),$.post("/api/holographic/mapmanager/importanchors?FileName="+i,function(){alert("Import was successful!")}).done(function(){r()}).fail(function(t){n("Failed to replace the anchors, check if the device is sleeping :"+t)}).always(function(){t.text("Import")}))});$("#LocalAnchorFilesGrid").on("click",".delete",function(){var t=$(this),r=t.data("spaceid");t.text("deleting ...");window.confirm("Delete selected map '"+r+"'?")&&$.post("/api/holographic/mapmanager/delete?FileName="+r).done(function(){i.UpdateLocalData()}).fail(function(t){n("Failed to delete :"+t)}).always(function(){t.text("Delete")})});$("#LocalSRDbFilesGrid").on("click",".download",function(){var t=$(this),i=t.data("spaceid"),r="/api/holographic/mapmanager/download?FileName="+i,n=document.createElement("iframe");n.setAttribute("src",r);n.setAttribute("style","display: none");document.body.appendChild(n)});$("#LocalSRDbFilesGrid").on("click",".import",function(){var t=$(this),i=t.data("spaceid");window.confirm("Replace the Spatial Mapping database with the selected database file: '"+i+"'?")&&(t.text("Importing ..."),$.post("/api/holographic/mapmanager/importspatialmappingdb?FileName="+i,function(){alert("Import was successful!")}).done(function(){r()}).fail(function(t){n("Failed to replace the Spatial Mapping database, check if the device is sleeping :"+t)}).always(function(){t.text("Import")}))});$("#LocalSRDbFilesGrid").on("click",".delete",function(){var t=$(this),i=t.data("spaceid");t.text("deleting ...");window.confirm("Delete selected Spatial Mapping database: '"+i+"'?")&&$.post("/api/holographic/mapmanager/delete?FileName="+i).done(function(){u.UpdateLocalData()}).fail(function(t){n("Failed to delete :"+t)}).always(function(){t.text("Delete")})});$("#UploadSpatialMappingDbFile").click(function(){$("#spatialMappingFile").click()});$("#spatialMappingFile").change(function(){var n=$("#spatialMappingFile").prop("files")[0],t;n.name.search(/\.srdbx$/)>0?(t=new FormData,t.append("file",n),$.ajax({url:"/api/holographic/mapmanager/upload",dataType:"json",cache:!1,contentType:!1,processData:!1,data:t,type:"post"}).done(function(){u.UpdateLocalData();$("#spatialMappingDbFileUpload")[0].reset();alert("Upload was successful!")})):alert('Spatial Mapping Database must have extension ".srdbx"\nFile: '+n.name)});$("#LocalAnchorFilesGrid").on("click",".download",function(){var t=$(this),i=t.data("spaceid"),r="/api/holographic/mapmanager/download?FileName="+i,n=document.createElement("iframe");n.setAttribute("src",r);n.setAttribute("style","display: none");document.body.appendChild(n)});$("#ExportSystemMapAndAnchors").bind("click",function(){$.post("/api/holographic/mapmanager/exportmapandanchors").done(function(n){var e="/api/holographic/mapmanager/download?FileName="+n.FileName,u=document.createElement("iframe"),f,r;u.setAttribute("src",e);u.setAttribute("style","display: none");document.body.appendChild(u);n.AnchorsFileName!=null&&(f="/api/holographic/mapmanager/download?FileName="+n.AnchorsFileName,r=document.createElement("iframe"),r.setAttribute("src",f),r.setAttribute("style","display: none"),document.body.appendChild(r));t.UpdateLocalData();i.UpdateLocalData();alert("Export was successful!")}).fail(function(t){n("Failed to export the map, check if the device is sleeping :"+t)})});$("#ExportMapAndSpatialMappingDb").bind("click",function(){$.post("/api/holographic/mapmanager/exportmapandspatialmappingdb").done(function(n){var e="/api/holographic/mapmanager/download?FileName="+n.SRDbFileName,r=document.createElement("iframe"),f,i;r.setAttribute("src",e);r.setAttribute("style","display: none");document.body.appendChild(r);n.MapFileName!=null&&(f="/api/holographic/mapmanager/download?FileName="+n.MapFileName,i=document.createElement("iframe"),i.setAttribute("src",f),i.setAttribute("style","display: none"),document.body.appendChild(i));u.UpdateLocalData();t.UpdateLocalData();alert("Export was successful!")}).fail(function(t){n("Failed to export the spatial mapping database and system map, check if the device is sleeping :"+t)})});$("#ResetSystemMapAndAnchorsAndSRDb").bind("click",function(){window.confirm("Reset the system map, anchors and spatial mapping database?")&&$.post("/api/holographic/mapmanager/resetmapandanchorsandsrdb").done(function(){r();t.UpdateLocalData();i.UpdateLocalData();u.UpdateLocalData()}).fail(function(t){n("Failed to reset the map, anchors or the spatial mapping database; check if the device is sleeping :"+t)})});$("#ResetSystemMapAndAnchors").bind("click",function(){window.confirm("Reset the system map and anchors?")&&$.post("/api/holographic/mapmanager/resetmapandanchorsandsrdb").done(function(){r();t.UpdateLocalData();i.UpdateLocalData()}).fail(function(t){n("Failed to reset the map or anchors; check if the device is sleeping :"+t)})});$("#ExportSystemMap").bind("click",function(){$.post("/api/holographic/mapmanager/export").done(function(n){var r="/api/holographic/mapmanager/download?FileName="+n.FileName,i=document.createElement("iframe");i.setAttribute("src",r);i.setAttribute("style","display: none");document.body.appendChild(i);t.UpdateLocalData();alert("Export was successful!")}).fail(function(t){n("Failed to export the map, check if the device is sleeping: ",t)})});$("#ExportSystemAnchors").bind("click",function(){$.post("/api/holographic/mapmanager/exportanchors").done(function(n){var r="/api/holographic/mapmanager/download?FileName="+n.FileName,t=document.createElement("iframe");t.setAttribute("src",r);t.setAttribute("style","display: none");document.body.appendChild(t);i.UpdateLocalData();alert("Export was successful!")}).fail(function(t){n("Failed to export the anchors, check if the device is sleeping :"+t)})});$("#UploadMapFile").click(function(){$("#mapFile").click()});$("#mapFile").change(function(){var n=$("#mapFile").prop("files")[0],i;n.name.search(/\.mapx$/)>0?(i=new FormData,i.append("file",n),$.ajax({url:"/api/holographic/mapmanager/upload",dataType:"json",cache:!1,contentType:!1,processData:!1,data:i,type:"post"}).done(function(){t.UpdateLocalData();$("#mapFileUpload")[0].reset();alert("Upload was successful!")})):alert('Map File must have extension ".mapx"\nFile: '+n.name)});$("#UploadAnchorsFile").click(function(){$("#anchorsFile").click()});$("#anchorsFile").change(function(){var n=$("#anchorsFile").prop("files")[0],t;n.name.search(/\.ancx$/)>0?(t=new FormData,t.append("file",n),$.ajax({url:"/api/holographic/mapmanager/upload",dataType:"json",cache:!1,contentType:!1,processData:!1,data:t,type:"post"}).done(function(){i.UpdateLocalData();$("#anchorsFileUpload")[0].reset();alert("Upload was successful!")})):alert('Anchors File must have extension ".ancx"\nFile: '+n.name)});$("#content").on("click",".guid-label:not(.active)",l);e=new k("#SystemAnchorsGrid");r();t.UpdateLocalData();i.UpdateLocalData();e.UpdateLocalData()})