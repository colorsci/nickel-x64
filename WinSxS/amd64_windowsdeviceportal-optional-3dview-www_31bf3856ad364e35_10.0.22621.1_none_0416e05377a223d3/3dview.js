function MirageConnector(){function e(t){n.$trackingStatus.text("Connecting ...");var i=document.location.protocol==="https:"?"wss://":"ws://",r=i+window.location.host+"/ext/perception/client?"+$.param({clientmode:t.trackingMode});n.socket=new WebSocket(r)}function o(t){t.TrackingState>n.stateToStringMap.length?n.$trackingStatus.text("Tracking: unexpected state"):n.$trackingStatus.text("Tracking: "+n.stateToStringMap[t.TrackingState])}function i(){$.get("/api/power/state").done(function(t){if(t.LowPowerStateAvailable===!0&&t.LowPowerState===!0)$("#pauseTracking").prop("disabled",!0),$("#getSRData").prop("disabled",!0),n.socket.send("pausetracking"),n.$trackingStatus.text("Tracking: sleeping");else{$("#pauseTracking").prop("disabled",!1);var i=$("#pauseTracking").prop("checked");i||(n.socket.send("resumetracking"),$("#getSRData").prop("disabled",!1))}}).fail(function(){}).always(function(){setTimeout(i,1e4)})}function s(n){n.HeadToAttachedFor!=undefined&&(r.updateQuaternionValues(getMatrixFromRestArray(n.HeadToAttachedFor)),u.updateVectorValues(getMatrixFromRestArray(n.OriginToAttachedFor).transpose()))}function h(n){f.updateHands(n)}function c(){n.socket&&(n.socket.readyState===WebSocket.OPEN||n.socket.readyState===WebSocket.CONNECTING)&&n.socket.close()}var n,t,r,u,f;this.$onOriginDataAvailable=$.Callbacks();this.$onMeshDataAvailable=$.Callbacks();this.$onGetSRDataPressed=$.Callbacks();this.$onHandDataAvailable=$.Callbacks();this.$onSpatialAnchorDataAvailable=$.Callbacks();n=this;n.$trackingStatus=$("#trackingStatus");n.stateToStringMap=["unavailable","orientation only","activating","active","inhibited"];e({trackingMode:"passive"});i();$("#activeClient").on("click",function(){var t=$(this).prop("checked");n.socket.send(t?"activeclient":"passiveclient")});$("#pauseTracking").on("click",function(){if($(this).prop("disabled")===!1){var t=$(this).prop("checked");$("#getSRData").prop("disabled",t);n.socket.send(t?"pausetracking":"resumetracking")}});$("#getSRData").on("click",function(){n.socket.send("getsrdata");n.$onGetSRDataPressed.fire();$("#srStats").text("SR data requested ...")});t=!1;$("#showDetails").on("click",function(){t=$("#showDetails").prop("checked");t?$("#details").show():$("#details").hide()});$("#getSpatialAnchors").on("click",function(){n.socket.send("getspatialAnchors")});r=new QuaternionViewer("rotationQuaternionGrid");u=new VectorViewer("translationVectorGrid");f=new HandsViewer("handsGrid");n.socket.onmessage=function(i){if(i.data!=""){var r=JSON.parse(i.data);r.SurfaceObserverStatus?r.SurfaceObserverStatus==="OK"?n.$onMeshDataAvailable.fire(r):$("#srStats").text(r.SurfaceObserverStatus):r.TrackingState?(o(r),n.$onOriginDataAvailable.fire(r)):r.eventType?(t&&h(r),n.$onHandDataAvailable.fire(r)):r.Anchors&&n.$onSpatialAnchorDataAvailable.fire(r);t&&s(r)}};n.socket.onerror=function(){n.$trackingStatus.text("Disconnected!")};n.socket.onclose=function(){n.$trackingStatus.text("Disconnected!")};n.socket.onopen=function(){n.$trackingStatus.text("Connected")};$(window).one("beforeunload",c)}function getMatrixFromRestArray(n){var t=new THREE.Matrix4;return t.set(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],n[12],n[13],n[14],n[15]),t}function getVector3FromRestArray(n){return new THREE.Vector3(n[0],n[1],n[2])}function getVector4FromRestArray(n){return new THREE.Vector4(n[0],n[1],n[2],n[3])}function QuaternionViewer(n){this.grid=new Slick.Grid("#"+n,[],[{id:"Const",name:"Const",field:"constValue",maxWidth:128,minWidth:128,cssClass:"tableCell",headerCssClass:"tableHeader"},{id:"I",name:"I",field:"i",maxWidth:128,minWidth:128,cssClass:"tableCell",headerCssClass:"tableHeader"},{id:"J",name:"J",field:"j",maxWidth:128,minWidth:128,cssClass:"tableCell",headerCssClass:"tableHeader"},{id:"K",name:"K",field:"k",maxWidth:128,minWidth:128,cssClass:"tableCell",headerCssClass:"tableHeader"}],{enableColumnReorder:!1,autoHeight:!0,rowHeight:36.5,headerRowHeight:40.45});$(window).resize(this.grid.resizeCanvas.bind(this.grid));this.updateQuaternionValues=function(n){var t=new THREE.Quaternion,r=new THREE.Vector3,u=new THREE.Vector3,i;n.decompose(r,t,u);i=[];i[0]={constValue:t.w.toFixed(6),i:t.x.toFixed(6),j:t.y.toFixed(6),k:t.z.toFixed(6)};this.grid.setData(i,!0);this.grid.render()}}function VectorViewer(n){this.grid=new Slick.Grid("#"+n,[],[{id:"X",name:"X",field:"x",maxWidth:128,minWidth:128,cssClass:"tableCell",headerCssClass:"tableHeader"},{id:"Y",name:"Y",field:"y",maxWidth:128,minWidth:128,cssClass:"tableCell",headerCssClass:"tableHeader"},{id:"Z",name:"Z",field:"z",maxWidth:128,minWidth:128,cssClass:"tableCell",headerCssClass:"tableHeader"}],{enableColumnReorder:!1,autoHeight:!0,rowHeight:36.5,headerRowHeight:40.45});$(window).resize(this.grid.resizeCanvas.bind(this.grid));this.updateVectorValues=function(n){var r=new THREE.Quaternion,t=new THREE.Vector3,u=new THREE.Vector3,i;n.decompose(t,r,u);i=[];i[0]={x:t.x.toFixed(6),y:t.y.toFixed(6),z:t.z.toFixed(6)};this.grid.setData(i,!0);this.grid.render()}}function HandsViewer(n){var t=[{id:0,x:0,y:0,z:0,isPressed:!1},{id:0,x:0,y:0,z:0,isPressed:!1}];this.grid=new Slick.Grid("#"+n,[],[{id:"ID",name:"ID",field:"id",width:128,cssClass:"tableCell",headerCssClass:"tableHeader"},{id:"X",name:"X",field:"x",width:128,cssClass:"tableCell",headerCssClass:"tableHeader"},{id:"Y",name:"Y",field:"y",width:128,cssClass:"tableCell",headerCssClass:"tableHeader"},{id:"Z",name:"Z",field:"z",width:128,cssClass:"tableCell",headerCssClass:"tableHeader"},{id:"IsPressed",name:"IsPressed",field:"isPressed",width:128,cssClass:"tableCell",headerCssClass:"tableHeader"}],{enableColumnReorder:!1,autoHeight:!0});$(window).resize(this.grid.resizeCanvas.bind(this.grid));this.updateHands=function(n){var i=this.grid.getData(),r,u;for(i.length===0&&(i=t),r=0;r<i.length;){if(i[r].id===n.id||i[r].id===0)break;++r}n.eventType==="HandLost"?(i.splice(r,1),i[1]={id:0,x:0,y:0,z:0,isPressed:!1}):(u=i[r].isPressed&&n.eventType!="FingerReleased"||!i[r].isPressed&&n.eventType=="FingerPressed",i[r]={id:n.id,x:n.x,y:n.y,z:n.z,isPressed:u});this.grid.setData(i,!0);this.grid.render()}}function ControllerTracker(n){var l=new THREE.BoxGeometry(.1,.05,.15),t={},e=[new THREE.MeshLambertMaterial({color:UndeterminedHandednessColor}),new THREE.MeshLambertMaterial({color:LeftHandednessColor}),new THREE.MeshLambertMaterial({color:RightHandednessColor})],f=new THREE.Geometry,o,i,s,r,h,u;f.vertices.push(new THREE.Vector3(0,0,0));f.vertices.push(new THREE.Vector3(1,0,0));o=new THREE.LineBasicMaterial({color:16711680});i=new THREE.Geometry;i.vertices.push(new THREE.Vector3(0,0,0));i.vertices.push(new THREE.Vector3(0,1,0));s=new THREE.LineBasicMaterial({color:65280});r=new THREE.Geometry;r.vertices.push(new THREE.Vector3(0,0,0));r.vertices.push(new THREE.Vector3(0,0,1));h=new THREE.LineBasicMaterial({color:255});u=new THREE.Geometry;u.vertices.push(new THREE.Vector3(0,0,0));u.vertices.push(new THREE.Vector3(0,0,-1));var a=new THREE.LineBasicMaterial({color:65535}),c=function(){var n=new THREE.Object3D;return n.add(new THREE.Line(f,o)),n.add(new THREE.Line(i,s)),n.add(new THREE.Line(r,h)),n},v=function(n,t,i,r,f){var o=new THREE.Object3D,s,h;(t!=undefined||i!=undefined)&&(o.add(new THREE.Mesh(l,e[n]||e[0])),o.add(c()),t!=undefined&&o.position.set(t[0],t[1],t[2]),i!=undefined&&o.quaternion.set(i[0],i[1],i[2],i[3]));var v=new THREE.Object3D,y=10,p=.1;return(r!=undefined||f!=undefined)&&(s=new THREE.Line(u,a),r!=undefined&&s.position.set(r[0],r[1],r[2]),f!=undefined&&s.quaternion.set(f[0],f[1],f[2],f[3]),s.scale.set(y,y,y),v.add(s),h=c(),r!=undefined&&h.position.set(r[0],r[1],r[2]),f!=undefined&&h.quaternion.set(f[0],f[1],f[2],f[3]),h.scale.set(p,p,p),v.add(h)),{holdingPoseObject:o,pointingPoseObject:v}};this.update=function(i){var f,e,u,r;for(f in t)n.remove(t[f].holdingPoseObject),n.remove(t[f].pointingPoseObject);t=[];e=i.ControllerData;for(u in e)r=e[u],t[u]=v(r.Handedness,r.HasPosition?r.Position:undefined,r.HasOrientation?r.Orientation:undefined,r.HasPointerPosition?r.PointerPosition:undefined,r.HasPointerOrientation?r.PointerOrientation:undefined),n.add(t[u].holdingPoseObject),n.add(t[u].pointingPoseObject)}}function HandsTracker(n){var r=new THREE.BoxGeometry(.1,.1,.1),u=new THREE.MeshLambertMaterial({color:UndeterminedHandednessColor}),t=[{id:0,x:0,y:0,z:0,isPressed:!1},{id:0,x:0,y:0,z:0,isPressed:!1}],i=[];this.update=function(f){var o=0,s=[],h,e;for(s[0]=t[0],s[1]=t[1];o<2;){if(t[o].id===f.id||t[o].id===0)break;++o}for(f.eventType==="HandLost"?(s.splice(o,1),s[1]={id:0,x:0,y:0,z:0,isPressed:!1}):(h=t[o].isPressed&&f.eventType!="FingerReleased"||!t[o].isPressed&&f.eventType=="FingerPressed",s[o]={id:f.id,x:f.x,y:f.y,z:f.z,isPressed:h}),e=0;e<2;++e)t[e].id!=0?s[e].id==0?(n.remove(i[e]),i[e].geometry.dispose()):i[e].position.set(t[e].x,t[e].y,t[e].z):s[e].id!=0&&(i[e]=new THREE.Mesh(r,u),i[e].position.set(t[e].x,t[e].y,t[e].z),n.add(i[e]));t=s}}function SRSurfaceMesh(n){function i(){for(var n in t.meshObjects)t.scene.remove(t.meshObjects[n].Mesh)}function r(){for(var n in t.meshObjects)t.scene.add(t.meshObjects[n].Mesh)}function u(n){t.clearMeshData(n.Surface.SurfaceId);e(n.Surface)}function f(){var n=0;for(var i in t.meshObjects)n+=t.meshObjects[i].triCount;return n}function e(n){var l,y,s,a,v,h,u,e,i,c,r,o,p;if(n.VertexTransform!=undefined){l=0;y=1;t.objFormatMesh=[];s=new THREE.Geometry;a=getMatrixFromRestArray(n.VertexTransform);a.transpose();v=getMatrixFromRestArray(n.NormalTransform);v.transpose();h=0;for(u in n.Vertices.x)e=n.Vertices,s.vertices.push(new THREE.Vector4(e.x[u]/32767,e.y[u]/32767,e.z[u]/32767,e.w[u]/32767)),h=e.y[u]<e.y[h]?u:h;for(s.applyMatrix(a),t.lowestPoint=Math.min(s.vertices[h].y,t.lowestPoint),i=0;i<n.Indices.length/3-3;i++){for(c=[],r=0;r<3;r++)c[r]=new THREE.Vector4(n.Normals.x[n.Indices[3*i+r]],n.Normals.y[n.Indices[3*i+r]],n.Normals.z[n.Indices[3*i+r]],n.Normals.w[n.Indices[3*i+r]]),c[r].applyMatrix4(v);s.faces.push(new THREE.Face3(n.Indices[3*i+2],n.Indices[3*i+1],n.Indices[3*i],c));l++}y+=n.Vertices.x.length;o={};o.Mesh=new THREE.Mesh(s,new THREE.MeshLambertMaterial({color:5618619}));o.SurfaceId=n.SurfaceId;o.Mesh.matrixAutoUpdate=!1;o.Mesh.updateMatrix();o.triCount=l;t.meshObjects.push(o);t.scene.add(t.meshObjects[t.meshObjects.length-1].Mesh);p=t.meshObjects.length.toString()+" volumes; "+f().toString()+" triangles";$("#srStats").text(p)}}function o(n){document.body.removeChild(n.target)}function s(){for(var n,c,l,r,u,f,e,a,o,v,s=1,i="\r\n\r\n",h=0;h<t.meshObjects.length;++h){for(i+="o Object."+(h+1)+"\r\n",n=t.meshObjects[h],c=0;c<n.Mesh.geometry.vertices.length;++c)l=n.Mesh.geometry.vertices[c],i+="v "+l.x+" "+l.y+" "+l.z+"\r\n";for(i+="\r\n\r\n",r={},u=0;u<n.Mesh.geometry.faces.length;++u)for(f=[],f[0]=n.Mesh.geometry.faces[u].a.toString(),f[1]=n.Mesh.geometry.faces[u].b.toString(),f[2]=n.Mesh.geometry.faces[u].c.toString(),e=0;e<3;++e)r[f[e]]==undefined&&(r[f[e]]=n.Mesh.geometry.faces[u].vertexNormals[e],r[f[e]].normalize());for(a=0;a<n.Mesh.geometry.vertices.length;++a)o=(a+1).toString(),i+=r[o]!=undefined?"vn "+r[o].x+" "+r[o].y+" "+r[o].z+"\r\n":"vn 0 0 0\r\n";for(i+="\r\n\r\n",v=0;v<n.Mesh.geometry.faces.length;++v){var y=n.Mesh.geometry.faces[v],p=y.a+s,w=y.b+s,b=y.c+s;i+="f "+p+"//"+p+" "+w+"//"+w+" "+b+"//"+b+"\r\n"}s+=n.Mesh.geometry.vertices.length;i+="\r\n\r\n"}return i}var t=this;this.meshObjects=[];this.scene=n;this.lowestPoint=Number.MAX_VALUE;t.objFormatMesh=[];this.updatePositionRelativeToAttachedFor=function(n){var i,r;if(n.OriginToAttachedFor){i=getMatrixFromRestArray(n.OriginToAttachedFor);i.transpose();for(r in t.meshObjects)t.meshObjects[r].Mesh.matrix=i}};this.setMeshData=function(n){return u(n)};this.clearMeshData=function(n){var i,r;if(n!=undefined){for(i in t.meshObjects)if(t.meshObjects[i].SurfaceId==n){t.scene.remove(t.meshObjects[i].Mesh);t.meshObjects[i].Mesh.geometry.dispose();t.meshObjects[i].Mesh.material.dispose();t.meshObjects.splice(i,1);break}}else{t.lowestPoint=Number.MAX_VALUE;for(r in t.meshObjects)t.scene.remove(t.meshObjects[r].Mesh),t.meshObjects[r].Mesh.geometry.dispose(),t.meshObjects[r].Mesh.material.dispose();t.meshObjects.splice(0,t.meshObjects.length)}};$("#showSRMesh").bind("click",function(){var n=$(this).prop("checked");n?r():i()});$("#saveSRData").bind("click",function(){var n;if(typeof Blob=="undefined"){alert("Operation failed - browser does not support blob format");return}var r=[s()],t=new Blob(r,{type:"text/plain",endings:"native"}),i="SpatialMapping.obj";window.navigator.msSaveOrOpenBlob?window.navigator.msSaveOrOpenBlob(t,i):(n=document.createElement("a"),n.download=i,n.href=window.URL.createObjectURL(t),n.onclick=o,n.style.display="none",document.body.appendChild(n),n.click())})}function PersonTracker(n){var i=new THREE.SphereGeometry(.25,32,16),r=new THREE.MeshLambertMaterial({color:16777215,transparent:!0,opacity:.9}),t=new THREE.Mesh(i,r);t.position.set(0,0,0);t.matrixAutoUpdate=!1;t.updateMatrix();n.add(t)}function WorldFloor(n){var i=new THREE.ImageUtils.loadTexture("tools/3dview/checkerboard.png"),r;i.wrapS=i.wrapT=THREE.RepeatWrapping;i.repeat.set(50,50);i.anisotropy=16;var f=new THREE.MeshBasicMaterial({map:i,side:THREE.DoubleSide,transparent:!0,opacity:.7}),e=new THREE.PlaneGeometry(100,100,1,1),t=new THREE.Mesh(e,f),u=new THREE.Matrix4;const o=-.2;t.matrixAutoUpdate=!1;t.updateMatrix();n.add(t);r=this;r.scene=n;r.setWorldFloor=function(n){u=(new THREE.Matrix4).makeTranslation(0,n+o,0);u.multiply((new THREE.Matrix4).makeRotationX(Math.PI/2));t.matrix=u};this.updatePositionRelativeToAttachedFor=function(n){if(n.OriginToAttachedFor){var i=getMatrixFromRestArray(n.OriginToAttachedFor);i.transpose();i.multiply(u);t.matrix=i}else $("#trackingState").text("Not tracking")};$("#showFloor").bind("click",function(){var n=$(this).prop("checked");n?r.scene.add(t):r.scene.remove(t)})}function SpatialAnchors(n){this.spatialAnchors=[];var t=this;t.scene=n;this.showSpatialAnchors=$("#showSpatialAnchors").prop("checked");this.setAnchors=function(n){var u,i,r;for(u in t.spatialAnchors)t.scene.remove(t.spatialAnchors[u]);t.spatialAnchors.splice(0,t.spatialAnchors.length);i=0;for(r in n.Anchors)n.Anchors[r].Transform!==undefined&&(t.spatialAnchors.push(new THREE.AxisHelper(.25)),i=t.spatialAnchors.length-1,t.spatialAnchors[i].matrixAutoUpdate=!1,t.spatialAnchors[i].transform=getMatrixFromRestArray(n.Anchors[r].Transform).transpose(),t.scene.add(t.spatialAnchors[i]),t.spatialAnchors[i].visible=t.showSpatialAnchors)};this.updatePositionRelativeToAttachedFor=function(n){var r,u,i;if(n.OriginToAttachedFor){r=getMatrixFromRestArray(n.OriginToAttachedFor);r.transpose();for(u in t.spatialAnchors)i=new THREE.Matrix4,i.multiply(r),i.multiply(t.spatialAnchors[u].transform),t.spatialAnchors[u].matrix=i}};$("#showSpatialAnchors").bind("click",function(){t.showSpatialAnchors=$(this).prop("checked");for(var n in t.spatialAnchors)t.spatialAnchors[n].visible=t.showSpatialAnchors})}function PositionLSRPlaneInViewSpace(n,t,i){return(new THREE.Matrix4).multiplyMatrices((new THREE.Matrix4).lookAt(new THREE.Vector3(0,0,0),t,i),(new THREE.Matrix4).makeTranslation(0,0,n))}function GenerateFrustum(n,t,i,r,u,f,e,o,s){var h=new THREE.Geometry;return h.vertices.push(t,i,r,u,t,f,e,i,t,u,s,o,r,o,e,f,s),new THREE.Line(h,n)}function IntersectPlanes(n,t,i){var f=new THREE.Matrix4,r,u;return f.set(n.x,n.y,n.z,0,t.x,t.y,t.z,0,i.x,i.y,i.z,0,0,0,0,1),r=new THREE.Vector4(-n.w,-t.w,-i.w,1),u=new THREE.Matrix4,u.getInverse(f),r.applyMatrix4(u),new THREE.Vector3(r.x,r.y,r.z)}function FrustumAndLSRPlane(n){var t=this,i,r;t.scene=n;t.frustum=new THREE.Object3D;t.frustum.matrixAutoUpdate=!1;t.scene.add(t.frustum);i=new THREE.PlaneGeometry(7,5,1,1);r=new THREE.MeshBasicMaterial({color:16711680,side:THREE.DoubleSide,opacity:.5,transparent:!0});t.lsrPlaneFocusPoint=new THREE.Mesh(i,r);t.lsrPlaneFocusPoint.matrixAutoUpdate=!1;$("#showPlane").on("click",function(){t.showLsrPlane=$(this).prop("checked");t.showLsrPlane?t.frustum.add(t.lsrPlane):t.frustum.remove(t.lsrPlane)});$("#showPlaneFocusPoint").on("click",function(){t.showLsrPlaneFocusPoint=$(this).prop("checked");t.showLsrPlaneFocusPoint?t.frustum.add(t.lsrPlaneFocusPoint):t.frustum.remove(t.lsrPlaneFocusPoint)});$("#showFrustum").on("click",function(){t.showFrustum=$(this).prop("checked");for(var n=0;n<t.frustums.length;++n)t.scene.remove(t.frustums[n]),t.frustums[n].geometry.dispose()});t.showLsrPlane=$("#showPlane").prop("checked");t.showLsrPlaneFocusPoint=$("#showPlaneFocusPoint").prop("checked");t.showFrustum=$("#showFrustum").prop("checked");t.showLsrPlane&&t.frustum.add(t.lsrPlane);t.frustums=[];t.frustumMaterial=new THREE.LineBasicMaterial({color:65280});this.updatePositionRelativeToAttachedFor=function(n){var i,r,a,u,f;if(n.Camera!=undefined){for(r=getMatrixFromRestArray(n.Camera.Displays[0].View),r.transpose(),a=new THREE.Vector3(0,1,0),a.applyMatrix4(r),n.Camera.Displays[0].FocusPointDisplay&&t.showLsrPlaneFocusPoint&&(u=getVector3FromRestArray(n.Camera.Displays[0].FocusPointDisplay),f=getVector3FromRestArray(n.Camera.Displays[0].FocusPointNormalDisplay),u.y=-u.y,u.z=-u.z,f.y=-f.y,f.z=-f.z,t.lsrPlaneFocusPoint.matrix=(new THREE.Matrix4).lookAt(new THREE.Vector3(0,0,0),f,a),t.lsrPlaneFocusPoint.matrix.setPosition(u)),t.lsrPlaneFocusPoint.matrixWorldNeedsUpdate=!0,r.getInverse(r),t.frustum.matrix=r,i=0;i<t.frustums.length;++i)t.scene.remove(t.frustums[i]),t.frustums[i].geometry.dispose();if(t.showFrustum)for(i=0;i<n.Camera.Displays.length;++i){var e=getVector4FromRestArray(n.Camera.Displays[i].Frustum.Right),o=getVector4FromRestArray(n.Camera.Displays[i].Frustum.Left),s=getVector4FromRestArray(n.Camera.Displays[i].Frustum.Top),h=getVector4FromRestArray(n.Camera.Displays[i].Frustum.Bottom),c=getVector4FromRestArray(n.Camera.Displays[i].Frustum.Far),l=getVector4FromRestArray(n.Camera.Displays[i].Frustum.Near),v=IntersectPlanes(s,o,l),y=IntersectPlanes(h,o,l),p=IntersectPlanes(h,o,c),w=IntersectPlanes(s,o,c),b=IntersectPlanes(s,e,l),k=IntersectPlanes(h,e,l),d=IntersectPlanes(h,e,c),g=IntersectPlanes(s,e,c);t.frustums[i]=GenerateFrustum(t.frustumMaterial,v,y,p,w,b,k,d,g);t.scene.add(t.frustums[i])}}}}function SceneManager(){function i(){var n,t,i=document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement;return i?(n=window.innerWidth,t=window.innerHeight):(n=1280,t=720),{width:n,height:t,aspect:n/t}}function u(){var t=i();n.renderer.setSize(t.width,t.height);n.camera.aspect=t.aspect;n.camera.updateProjectionMatrix()}function f(n){var r=i();n.camera=new THREE.PerspectiveCamera(45,r.aspect,.1,1e4);n.controls=null;n.camera.matrixAutoUpdate=!t;t||(n.camera.position.z=5,n.camera.position.y=1,n.controls=new THREE.OrbitControls(n.camera,document,n.renderer.domElement))}function o(){var t=i(),n={},r=document.getElementById("3dPreviewCanvas");return n.renderer=new THREE.WebGLRenderer({canvas:r}),n.renderer.setSize(t.width,t.height),f(n,!1),window.addEventListener("resize",u,!1),n}function s(i){if(t){var r=(new THREE.Matrix4).getInverse(getMatrixFromRestArray(i.HeadToAttachedFor));n.camera.matrix=r;n.camera.matrixWorldNeedsUpdate=!0}}function h(){var n=document.getElementById("3dPreviewCanvas");n&&(n.requestFullScreen?n.requestFullScreen():n.webkitRequestFullScreen?n.webkitRequestFullScreen():n.mozRequestFullScreen&&n.mozRequestFullScreen())}function c(n){var i,t;n.scene=new THREE.Scene;n.scene.add(n.camera);n.personTracker=new PersonTracker(n.scene);n.worldFloor=new WorldFloor(n.scene);n.controllers=new ControllerTracker(n.scene);n.hands=new HandsTracker(n.scene);n.anchors=new SpatialAnchors(n.scene);n.mirageConnector.$onOriginDataAvailable.add(n.worldFloor.updatePositionRelativeToAttachedFor);n.frustumAndLSRPlane=new FrustumAndLSRPlane(n.scene);n.mirageConnector.$onOriginDataAvailable.add(n.frustumAndLSRPlane.updatePositionRelativeToAttachedFor);n.mirageConnector.$onOriginDataAvailable.add(s);n.mirageConnector.$onOriginDataAvailable.add(n.controllers.update);n.mirageConnector.$onHandDataAvailable.add(n.hands.update);n.mirageConnector.$onSpatialAnchorDataAvailable.add(n.anchors.setAnchors);n.mirageConnector.$onOriginDataAvailable.add(n.anchors.updatePositionRelativeToAttachedFor);n.worldFloor.setWorldFloor(r);i=new THREE.PointLight(16777215,1,0);i.position.set(0,10,0);n.scene.add(i);t=new THREE.HemisphereLight(16777215,16777215,.6);t.color.setHSL(.6,1,.6);t.groundColor.setHSL(.095,1,.75);t.position.set(0,50,0);n.scene.add(t)}function l(n){function i(i){t.setMeshData(i);n.worldFloor.setWorldFloor(Math.min(t.lowestPoint,r))}var t=new SRSurfaceMesh(n.scene);n.mirageConnector.$onMeshDataAvailable.add(i);n.mirageConnector.$onOriginDataAvailable.add(t.updatePositionRelativeToAttachedFor);n.mirageConnector.$onGetSRDataPressed.add(function(){t.clearMeshData()})}function e(){n.animationFrameHandle=window.requestAnimationFrame(e);t||n.controls.update();n.renderer.render(n.scene,n.camera)}function a(){document.getElementById("3dPreviewCanvas")&&(window.cancelAnimationFrame(n.animationFrameHandle),n.controls.dispose())}var n,t;const r=-1.5;n=o();n.mirageConnector=new MirageConnector;c(n);l(n);e();t=$("#firstPerson").prop("checked");$("#firstPerson").on("click",function(){t=$("#firstPerson").prop("checked");f(n)});$("#goFullscreen").on("click",function(){h();u()});$(window).one("beforeunload",a)}var LeftHandednessColor=255,RightHandednessColor=16711680,UndeterminedHandednessColor=13487565;$(function(){SceneManager()})